<!-- User Settings -->
<script>
var congName = "Name"
//enable true if multiple servers are used.
//If true will add links to server in toolbar
var multiLinksEnabled = false
var multiServers=[]
//multiServers.push(["Type of Territory","IP of TerraNova Server for type"])
multiServers.push(["Residential","10.0.20.2:3000"])
multiServers.push(["Residential2","10.0.20.2:3001"])
multiServers.push(["Residential3","10.0.20.2"])
</script>

<link rel="stylesheet" type="text/css" href="index.css">

<!-- Javascript Functions -->
<script>
  function appendHTML(element, contents) {
    document.getElementById(element).innerHTML=(document.getElementById(element).innerHTML + contents)
  }

  function insertHTML(element, contents) {
    document.getElementById(element).innerHTML=(contents + document.getElementById(element).innerHTML)
  }

  function terrinsViewDetails(terrinid) {
    document.getElementById("detailFrame").src = ("terrins/" + terrinid)
  }

  function terroutsViewDetails(terroutid) {
    document.getElementById("detailFrame").src = ("terrouts/" + terroutid)
  }

  function terrsViewDetails(terrid) {
    document.getElementById("detailFrame").src = ("terrs/" + terrid)
  }

  function setToolbar() {
    insertHTML("toolHead", (congName + " "))
    if (multiLinksEnabled){
      for (id=0; id<multiServers.length; id++){
        appendHTML("toolLinks",("<td id='server"+id+"Link'><a href='http://"+multiServers[id][1]+"'>"+multiServers[id][0]+"</a></td>"))
      }
    }
  }
</script>

<%# Ruby pre-render functions %>
<%# will store terrid of all territories check in or out %>
<% categorizedTerrs =[] %>
<%# calculate when start of service year was %>
<% if Time.now.month>=9 %>
  <% svcYearStart=Time.new(Time.now.year,9,1) %>
<% else %>
  <% svcYearStart=Time.new(Time.now.year-1,9,1) %>
<% end %>
<%# calculate how many territories completed during service year %>
<% compCurYear=0 %>
<% @terrs.each do |terr| %>
  <% if terr.datecomp > svcYearStart then compCurYear+=1 end %>
<% end %>
<%# Do same for last 12 months %>
<% compLast12=0 %>
<% yrAgo = Time.new(Time.now.year-1, Time.now.month, Time.now.day) %>
<% @terrs.each do |terr| %>
  <% if terr.datecomp > yrAgo then compLast12+=1 end %>
<% end %>
<%# If current month is Sep do the same for last service year for record keeping %>
<% lastSvcYear=false %>
<% if Time.now.month==9 %>
  <% lastSvcYear=Time.new(svcYearStart.year-1,9,1) %>
  <% compLastYear=0 %>
  <% @terrs.each do |terr| %>
    <% if terr.datecomp>lastSvcYear && terr.datecomp<svcYearStart then compLastYear+=1 end %>
  <% end %>
<% end %>

<div id="toolbar" style="position:fixed;width:100%;top:0px;left:0px;right:0px;border-bottom:1px solid #000;z-index:1">
    <div id="toolHead" align="left" style="left:5px;display:inline-block;font-size:20px;font-weight:bold">Congregation Territory</div>
    <table align="right">
      <tr id="toolLinks"> </tr>
    </table>
</div>

<!-- Left side report view -->
<div id="reportWindow" style="width:49vw;position:absolute;left:1px;top:45px">
  <!-- table to display service year completion stats -->
  <a href='/report/print' target='_blank' style="position:absolute;right:5px">Print Worksheet</a>
  <a id="exportdownload" style="position:absolute;right:5px;top:15px"></a>
  <a href='/report/history' target='_blank' style="position:absolute;right:5px;top:30px">History of Check-In/Out</a>
  <a href='/dncs' target='_blank' style="position:absolute;right:5px;top:45px">DNC Database</a>
  <a href='/terrs' target='_blank' style="position:absolute;right:5px;top:60px">Territory Database</a>
  <div id="svcYearStats">
    <table>
      <thead>
        <tr>
          <th>Time Frame</th>
          <th>Completed</th>
          <th>Total</th>
          <th>Percent</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><%= svcYearStart.year %> Service Year</td>
          <td><%= compCurYear %></td>
          <td><%= @terrs.length %></td>
          <td><%= (compCurYear.to_f/@terrs.length*100).round(2) %></td>
        </tr>
	<tr>
          <td>Since <%= yrAgo.strftime("%m/%d/%y") %></td>
          <td><%= compLast12 %></td>
          <td><%= @terrs.length %></td>
          <td><%= (compLast12.to_f/@terrs.length*100).round(2) %></td>
        </tr>
        <% if lastSvcYear %>
          <tr>
            <td><%= lastSvcYear.year %> Service Year</td>
            <td><%= compLastYear %></td>
            <td><%= @terrs.length %></td>
            <td><%= (compLastYear.to_f/@terrs.length*100).round(2) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- table to display terrouts -->
  <div id="terrOuts">
    <h2>Checked Out Territories</h2>

    <table id="terrouttable">
      <thead>
        <tr>
          <th>Territory</th>
          <th>Last Complete</th>
          <th>Publisher</th>
          <th>Date Out</th>
          <th>Date Due</th>
        </tr>
      </thead>

      <tbody>
        <% @terrouts.sort_by{|terrout| terrout.datedue}.each do |terrout| %>
          <% categorizedTerrs<<terrout.terrid %>
          <% if terrout.datedue-Date.current<0 %>
            <% dateClass="late" %>
          <% elsif (terrout.datedue-1.months)-Date.current<0%>
            <% dateClass="warn" %>
          <% else %>
            <% dateClass="normal" %>
          <% end %>
          <tr>
            <td class="<%= dateClass %>" style="white-space:pre"><%= @terrs.find(terrout.terrid).name %><br><%= @terrs.find(terrout.terrid).region %></td>
            <td><%= @terrs.find(terrout.terrid).datecomp.strftime("%m/%d/%y") %></td>
            <td><%= terrout.publisher %></td>
            <td><%= terrout.dateout.strftime("%m/%d/%y") %></td>
            <td><%= terrout.datedue.strftime("%m/%d/%y") %></td>
            <td><a href="#" onclick="terroutsViewDetails('<%= terrout.id %>');return false;">View Details</a></td>
            <td><%= link_to 'Check In', [terrout,checkin: terrout.terrid], method: :delete, data: { confirm: "Are you sure you want to check in #{@terrs.find(terrout.terrid).name}?" } %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- table to display terrins -->
  <div id="terrIns">
    <h2>Checked In Territories</h2>

    <table id="terrintable">
      <thead>
        <tr>
          <th>Territory</th>
          <th>Last Complete</th>
        </tr>
      </thead>

      <tbody>
        <% @terrins.sort_by{|terrin| @terrs.find(terrin.terrid).datecomp}.each do |terrin| %>
        <% categorizedTerrs<<terrin.terrid %>
          <tr>
            <td style="white-space:pre-wrap"><%= @terrs.find(terrin.terrid).name %><br><%= @terrs.find(terrin.terrid).region %></td>
            <td><%= @terrs.find(terrin.terrid).datecomp.strftime("%m/%d/%y") %></td>
            <td><a href="#" onclick="terrinsViewDetails('<%= terrin.id %>');return false;">View Details</a></td>
            <td><%= link_to 'Check Out', [terrin,checkout: terrin.terrid], method: :delete, data: { confirm: "Are you sure you want to check out #{@terrs.find(terrin.terrid).name}?" } %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- table to display terrs that aren't out or in -->
  <div id="otherTerrs">
    <h2>Other Territories</h2>

    <table id="terrtable">
      <thead>
        <tr>
          <th>Territory</th>
          <th>Last Complete</th>
        </tr>
      </thead>

      <tbody>
        <% @terrs.sort_by{|terr| terr.datecomp}.each do |terr| %>
          <% if categorizedTerrs.find_index(terr.id) %>
          <% else %>
            <tr>
              <td style="white-space:pre-wrap"><%= terr.name %><br><%=terr.region %></td>
              <td><%= terr.datecomp.strftime("%m/%d/%y") %></td>
              <td><a href='#' onclick="terrsViewDetails('<%= terr.id %>');return false;">View Details</a></td>
              <td><%= link_to 'Check Out', {:controller => "terrouts", :action => "new", :terrid => terr.id} %></td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!--Detail display window off to right side-->
<div id="detailWindow" style="position:fixed;width:49vw;height:90vh;right:2px;top:43px;border:0px solid #ff4a2b;overflow-x:hidden;overflow-y:scroll; -webkit-overflow-scrolling: touch">
  <iframe id="detailFrame" style='width:99%;height:99%'> </iframe>
</div>

<script>  window.onload = setToolbar(); </script>
<script>
//This script section creates a downloadable CSV of all the territory listings
//and updates the page to have a link in a predefined spot
  csvdata=["Territory,Last Complete,Publisher,Date Out,Date Due"]
  terrouttable=document.getElementById("terrouttable").tBodies[0].rows
  terrintable=document.getElementById("terrintable").tBodies[0].rows
  terrtable=document.getElementById("terrtable").tBodies[0].rows
  allterrs=[]
  i=0
  while (i<terrouttable.length) {
    row=terrouttable[i].cells
    temp=[]
    temp.push("\""+row[0].innerHTML.split("<br>").join(" ")+"\"")
    temp.push("\""+row[1].innerText+"\"")
    temp.push("\""+row[2].innerText+"\"")
    temp.push("\""+row[3].innerText+"\"")
    temp.push("\""+row[4].innerText+"\"")
    allterrs.push(temp)
    i+=1
  }
  i=0
  while (i<terrintable.length) {
    row=terrintable[i].cells
    temp=[]
    temp.push("\""+row[0].innerHTML.split("<br>").join(" ")+"\"")
    temp.push("\""+row[1].innerText+"\"")
    temp.push("\"\"")
    temp.push("\"\"")
    temp.push("\"\"")
    allterrs.push(temp)
    i+=1
  }
  i=0
  while (i<terrtable.length) {
    row=terrtable[i].cells
    temp=[]
    temp.push("\""+row[0].innerHTML.split("<br>").join(" ")+"\"")
    temp.push("\""+row[1].innerText+"\"")
    temp.push("\"\"")
    temp.push("\"\"")
    temp.push("\"\"")
    allterrs.push(temp)
    i+=1
  }
  allterrs=allterrs.sort(function(a,b){return new Date(a[1]) - new Date(b[1])})
  i=0
  while (i<allterrs.length){
    csvdata.push(allterrs[i])
    i+=1
  }
  csvstring=csvdata.join("\n")
  csv= new Blob([csvstring], {type: 'text/csv; header=present'})
  downloadlink=URL.createObjectURL(csv)
  linkloc=document.getElementById("exportdownload")
  linkloc.download = 'territories.csv'
  linkloc.href = downloadlink
  linkloc.textContent='Export Information'
</script>
